<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maison Jebrane - Villeparisis</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --cell-padding: 6px; --font-size-base: 0.85em; }
        body { font-family: 'Playfair Display', serif; margin: 0; padding: 20px; background-color: #1a1a1a; color: #f4f4f4; }
        .container { max-width: 1600px; margin: auto; }
        .header { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #D4AF37; padding-bottom: 15px; }
        .logo { height: 50px; }
        h2 { color: #D4AF37; margin: 0; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Panneau Admin */
        .admin-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .box { background: #262626; padding: 15px; border-radius: 12px; border: 1px solid #444; }
        h3 { color: #D4AF37; font-size: 0.8em; text-transform: uppercase; margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 10px; }
        .form-row { display: flex; flex-direction: column; gap: 10px; }
        
        select, input { padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 6px; font-family: sans-serif; }
        .btn { padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; text-transform: uppercase; font-size: 0.8em; transition: 0.2s; }
        .btn-gold { background: linear-gradient(45deg, #D4AF37, #F9E586); color: #1a1a1a; }
        .btn-orange { background: #e67e22; color: white; }
        .btn-outline { background: transparent; border: 1px solid #D4AF37; color: #D4AF37; }
        .btn-danger { background: #721c24; color: #f8d7da; border: 1px solid #f5c6cb; }
        
        /* Tableaux */
        .categorie-container { margin-bottom: 30px; border: 1px solid #444; border-radius: 12px; overflow: hidden; }
        .cat-title { background: #D4AF37; color: #1a1a1a; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; cursor: grab; }
        .table-container { overflow: auto; max-height: 65vh; background: #262626; }
        
        table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: var(--font-size-base); }
        thead th { position: sticky; top: 0; z-index: 20; background: #1a1a1a; color: #D4AF37; padding: 12px; border: 1px solid #3d3d3d; }
        th:first-child, td:first-child { position: sticky; left: 0; z-index: 10; background: #1a1a1a !important; border-right: 2px solid #D4AF37 !important; }
        
        td { border: 1px solid #3d3d3d; text-align: center; padding: var(--cell-padding); }
        .handle-prod { cursor: grab; color: #D4AF37; padding-right: 10px; }
        .prod-name { font-weight: bold; text-align: left; padding-left: 10px; min-width: 180px; display: flex; align-items: center; }
        
        .cell-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; }
        .sub-cell { background: #333; border-radius: 4px; display: flex; flex-direction: column; padding: 4px; }
        .label-sub { font-size: 0.55em; color: #aaa; }
        .val-obj { background: transparent; color: #fff; border: none; width: 100%; text-align: center; font-weight: bold; font-size: 1.1em; }
        .val-stock { color: #D4AF37; font-weight: bold; font-size: 1.1em; }
        .val-prod { color: #F9E586; font-weight: bold; font-size: 1.2em; }
        
        /* Zoom */
        body.zoom-large { --cell-padding: 12px; --font-size-base: 1.1em; }
        body.zoom-large .sub-cell { padding: 8px; }

        #status { font-size: 0.6em; padding: 4px 10px; border-radius: 20px; border: 1px solid #D4AF37; color: #D4AF37; }
        .delete-icon { color: #ff4d4d; cursor: pointer; margin-left: 10px; font-weight: bold; }
        .hidden-col { display: none; }
    </style>
</head>
<body class="zoom-normal">

<div class="container">
    <div class="header">
        <img src="logo.png" alt="" class="logo">
        <h2>Maison Jebrane Villeparisis <span id="status">Connexion...</span></h2>
    </div>

    <div class="admin-panel">
        <div class="box">
            <h3>1. P√©riode & Rapports</h3>
            <div class="form-row">
                <div style="display:flex; gap:5px;">
                    <input type="date" id="dateDebut" onchange="sauverDates()" style="flex:1;">
                    <input type="date" id="dateFin" onchange="sauverDates()" style="flex:1;">
                </div>
                <button class="btn btn-gold" onclick="exporterExcel()">üìä T√©l√©charger Rapport Excel</button>
                <button class="btn btn-orange" onclick="resetStocksUniquement()">üîÑ Vider les stocks de la semaine</button>
            </div>
        </div>

        <div class="box">
            <h3>2. Gestion Catalogue</h3>
            <div class="form-row">
                <div style="display:flex; gap:5px;">
                    <input type="text" id="nomCat" placeholder="Ex: Trompe l'oeil..." style="flex:1;">
                    <button class="btn btn-outline" onclick="ajouterCategorie()" title="Ajouter cat√©gorie">+</button>
                </div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="nomProd" placeholder="Ex: Pistache..." style="flex:1;">
                    <select id="selectCat" style="flex:1;"></select>
                    <button class="btn btn-gold" onclick="ajouterProduit()" title="Ajouter produit">+</button>
                </div>
            </div>
        </div>

        <div class="box">
            <h3>3. Mise √† jour Stock</h3>
            <div class="form-row">
                <input type="text" id="quickSearch" placeholder="üîç Recherche rapide produit..." oninput="quickSearchProd()">
                <div style="display:flex; gap:5px;">
                    <select id="stockCatSelect" onchange="updateStockProdList()" style="flex:1;"></select>
                    <select id="stockProdSelect" style="flex:2;"></select>
                </div>
                <div style="display:flex; gap:5px;">
                    <select id="stockJourSelect" style="flex:1;"></select>
                    <input type="number" id="stockValeur" value="0" style="width:70px;">
                    <button class="btn btn-gold" onclick="validerStock()">Valider</button>
                </div>
            </div>
        </div>

        <div class="box">
            <h3>4. Affichage</h3>
            <div class="form-row">
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-outline" onclick="changeZoom('normal')" style="flex:1;">Mode Normal</button>
                    <button class="btn btn-outline" onclick="changeZoom('large')" style="flex:1;">Mode Large</button>
                </div>
                <select id="viewMode" onchange="relancerRender()">
                    <option value="semaine">üìÖ Vue Semaine compl√®te</option>
                    <option value="Lundi">Lundi</option><option value="Mardi">Mardi</option>
                    <option value="Mercredi">Mercredi</option><option value="Jeudi">Jeudi</option>
                    <option value="Vendredi">Vendredi</option><option value="Samedi">Samedi</option>
                    <option value="Dimanche">Dimanche</option>
                </select>
                <button class="btn btn-outline" id="btnFiltre" onclick="toggleFiltre()">üîç Masquer les lignes avec un reste √† 0</button>
            </div>
        </div>
    </div>

    <div id="listeCategories"></div>
    
    <div style="margin-top: 50px; padding: 20px; border-top: 1px solid #444; text-align: center;">
        <button class="btn btn-danger" onclick="resetTotal()">‚ö†Ô∏è R√âINITIALISATION COMPL√àTE DU SYST√àME</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, remove, push, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAbrOwjPc1eOpMF8I8A-LLhiPO8toiu3oQ",
    authDomain: "maison-jebrane.firebaseapp.com",
    databaseURL: "https://maison-jebrane-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "maison-jebrane",
    storageBucket: "maison-jebrane.firebasestorage.app",
    messagingSenderId: "541926034379",
    appId: "1:541926034379:web:f22192e8e40e343a9f044e",
    measurementId: "G-JQ6XFRENN1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const jours = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
  let globalData = {};
  let filtreActif = false;
  let wakeLock = null;

  // Anti-veille
  const requestWakeLock = async () => {
    try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
  };
  document.addEventListener('click', () => { if(!wakeLock) requestWakeLock(); }, { once: true });

  // Zoom
  window.changeZoom = (l) => { document.body.className = `zoom-${l}`; localStorage.setItem('mj-zoom', l); };
  if(localStorage.getItem('mj-zoom')) changeZoom(localStorage.getItem('mj-zoom'));

  // Sync Firebase
  onValue(ref(db, '/'), (snapshot) => {
    globalData = snapshot.val() || {};
    document.getElementById('status').innerText = "‚óè EN LIGNE";
    if(globalData.config && globalData.config.dates) {
        document.getElementById('dateDebut').value = globalData.config.dates.debut || "";
        document.getElementById('dateFin').value = globalData.config.dates.fin || "";
    }
    render(globalData);
  });

  window.relancerRender = () => { render(globalData); };

  function render(data) {
    const containers = data.categories || {};
    const production = data.production || {};
    const parent = document.getElementById('listeCategories');
    const selectCat = document.getElementById('selectCat');
    const stockCatSelect = document.getElementById('stockCatSelect');
    const viewMode = document.getElementById('viewMode').value;
    
    const currentStockCat = stockCatSelect.value;
    const currentStockProd = document.getElementById('stockProdSelect').value;

    parent.innerHTML = ""; 
    // Initialisation du select catalogue avec "Choix cat√©gorie..."
    selectCat.innerHTML = '<option value="">Choix cat√©gorie...</option>';
    stockCatSelect.innerHTML = '<option value="">-- Cat√©gorie --</option>';

    const sortedCatKeys = Object.keys(containers).sort((a,b) => (containers[a].ordre || 0) - (containers[b].ordre || 0));

    sortedCatKeys.forEach(catID => {
        const cat = containers[catID];
        selectCat.add(new Option(cat.nom, catID));
        stockCatSelect.add(new Option(cat.nom, catID));

        const section = document.createElement('div');
        section.className = "categorie-container";
        section.dataset.id = catID;

        let headerHtml = `<thead><tr><th>Produits</th>`;
        jours.forEach(j => {
            const isHidden = (viewMode !== "semaine" && viewMode !== j) ? "hidden-col" : "";
            headerHtml += `<th class="${isHidden}">${j}</th>`;
        });
        headerHtml += `</tr></thead>`;

        section.innerHTML = `
            <div class="cat-title">
                <span>‚ò∞ ${cat.nom}</span>
                <span class="delete-icon" onclick="supprimerCat('${catID}')">‚úï</span>
            </div>
            <div class="table-container">
                <table>
                    ${headerHtml}
                    <tbody id="body-${catID}"></tbody>
                </table>
            </div>
        `;

        const tbody = section.querySelector('tbody');
        const produits = cat.produits || {};
        const sortedProdKeys = Object.keys(produits).sort((a,b) => (produits[a].ordre || 0) - (produits[b].ordre || 0));

        sortedProdKeys.forEach(pID => {
            const pName = produits[pID].nom;
            if (filtreActif) {
                const checkDay = (viewMode === "semaine") ? jours : [viewMode];
                const aFaire = checkDay.some(j => {
                    const v = (production[pID] && production[pID][j]) ? production[pID][j] : { obj: 0, stock: 0 };
                    return (parseInt(v.obj)||0) - (parseInt(v.stock)||0) > 0;
                });
                if (!aFaire) return;
            }

            const tr = document.createElement('tr');
            tr.dataset.id = pID;
            let htmlProd = `<td class="prod-name">
                <span class="handle-prod">‚ãÆ‚ãÆ</span> ${pName}
                <span class="delete-icon" onclick="supprimerProd('${catID}','${pID}')" style="font-size:0.8em; opacity:0.3">‚úï</span>
            </td>`;
            
            jours.forEach(j => {
                const isHidden = (viewMode !== "semaine" && viewMode !== j) ? "hidden-col" : "";
                const vals = (production[pID] && production[pID][j]) ? production[pID][j] : { obj: 0, stock: 0 };
                const reste = Math.max(0, (parseInt(vals.obj)||0) - (parseInt(vals.stock)||0));
                htmlProd += `<td class="${isHidden}">
                    <div class="cell-grid">
                        <div class="sub-cell"><span class="label-sub">Obj</span><input type="number" class="val-obj" value="${vals.obj||0}" onchange="updateVal('${pID}','${j}','obj',this.value)"></div>
                        <div class="sub-cell"><span class="label-sub">Stk</span><span class="val-stock">${vals.stock||0}</span></div>
                        <div class="sub-cell"><span class="label-sub">Rst</span><span class="val-prod">${reste}</span></div>
                    </div>
                </td>`;
            });
            tr.innerHTML = htmlProd;
            tbody.appendChild(tr);
        });
        parent.appendChild(section);

        new Sortable(tbody, {
            handle: '.handle-prod', animation: 150,
            onEnd: function() {
                tbody.querySelectorAll('tr').forEach((row, i) => update(ref(db, `categories/${catID}/produits/${row.dataset.id}`), { ordre: i }));
            }
        });
    });

    new Sortable(parent, {
        handle: '.cat-title', animation: 150,
        onEnd: function() {
            parent.querySelectorAll('.categorie-container').forEach((block, i) => update(ref(db, `categories/${block.dataset.id}`), { ordre: i }));
        }
    });

    stockCatSelect.value = currentStockCat;
    updateStockProdList();
    document.getElementById('stockProdSelect').value = currentStockProd;
  }

  // --- ACTIONS ---
  window.quickSearchProd = () => {
      const search = document.getElementById('quickSearch').value.toLowerCase();
      if (search.length < 2) return;
      for (let cID in globalData.categories) {
          const prods = globalData.categories[cID].produits || {};
          for (let pID in prods) {
              if (prods[pID].nom.toLowerCase().includes(search)) {
                  document.getElementById('stockCatSelect').value = cID;
                  updateStockProdList();
                  document.getElementById('stockProdSelect').value = `${cID}/${pID}`;
                  return;
              }
          }
      }
  };

  window.updateStockProdList = () => {
      const cID = document.getElementById('stockCatSelect').value;
      const ps = document.getElementById('stockProdSelect');
      ps.innerHTML = '<option value="">-- Produit --</option>';
      if(cID && globalData.categories[cID]) {
          const prods = globalData.categories[cID].produits || {};
          Object.keys(prods).sort((a,b)=>(prods[a].ordre||0)-(prods[b].ordre||0)).forEach(pID => ps.add(new Option(prods[pID].nom, `${cID}/${pID}`)));
      }
  };

  window.validerStock = () => {
    const pVal = document.getElementById('stockProdSelect').value;
    const jVal = document.getElementById('stockJourSelect').value || jours[new Date().getDay() === 0 ? 6 : new Date().getDay()-1];
    const sVal = document.getElementById('stockValeur').value;
    if(!pVal) return alert("Choisissez un produit");
    const [cID, pID] = pVal.split('/');
    set(ref(db, `production/${pID}/${jVal}/stock`), sVal).then(() => {
        document.getElementById('stockValeur').value = 0;
        document.getElementById('quickSearch').value = "";
    });
  };

  window.ajouterCategorie = () => { const n = document.getElementById('nomCat').value; if(n) { push(ref(db, 'categories'), { nom: n, ordre: 99 }); document.getElementById('nomCat').value=""; } };
  window.ajouterProduit = () => { 
      const n = document.getElementById('nomProd').value; 
      const c = document.getElementById('selectCat').value; 
      if(n && c) { push(ref(db, `categories/${c}/produits`), { nom: n, ordre: 99 }); document.getElementById('nomProd').value=""; }
      else { alert("Veuillez donner un nom et choisir une cat√©gorie valide."); }
  };
  window.supprimerProd = (c, p) => { if(confirm("Supprimer ce produit ?")) remove(ref(db, `categories/${c}/produits/${p}`)); };
  window.supprimerCat = (c) => { if(confirm("Supprimer toute la cat√©gorie ?")) remove(ref(db, `categories/${c}`)); };
  window.updateVal = (p, j, t, v) => set(ref(db, `production/${p}/${j}/${t}`), v);
  window.sauverDates = () => set(ref(db, 'config/dates'), { debut: document.getElementById('dateDebut').value, fin: document.getElementById('dateFin').value });
  
  window.toggleFiltre = () => { 
      filtreActif = !filtreActif; 
      const btn = document.getElementById('btnFiltre');
      if(filtreActif) {
          btn.innerHTML = "üëÅÔ∏è Afficher toutes les lignes";
          btn.classList.add('btn-orange');
      } else {
          btn.innerHTML = "üîç Masquer les lignes avec un reste √† 0";
          btn.classList.remove('btn-orange');
      }
      render(globalData); 
  };

  window.resetTotal = () => { if(confirm("‚ö†Ô∏è TOUT EFFACER ?")) remove(ref(db, '/')); };
  window.resetStocksUniquement = async () => {
      if(confirm("Remettre tous les stocks √† z√©ro ?")) {
          const s = await get(ref(db, 'production'));
          if(s.exists()){
              let d = s.val();
              Object.keys(d).forEach(p => Object.keys(d[p]).forEach(j => d[p][j].stock = 0));
              set(ref(db, 'production'), d);
          }
      }
  };

  // Init jours
  const sj = document.getElementById('stockJourSelect');
  jours.forEach(j => sj.add(new Option(j, j)));

  window.exporterExcel = () => {
    const wb = XLSX.utils.book_new();
    const cats = globalData.categories || {};
    const prod = globalData.production || {};
    Object.keys(cats).forEach(cID => {
        const rows = [["Produit", "Lundi (Obj/Stk/Rst)", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"]];
        const pList = cats[cID].produits || {};
        Object.keys(pList).forEach(pID => {
            const r = [pList[pID].nom];
            jours.forEach(j => {
                const v = (prod[pID] && prod[pID][j]) ? prod[pID][j] : {obj:0, stock:0};
                r.push(`${v.obj||0} / ${v.stock||0} / ${Math.max(0,(v.obj||0)-(v.stock||0))}`);
            });
            rows.push(r);
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), cats[cID].nom.substring(0,30));
    });
    XLSX.writeFile(wb, `Rapport_Villeparisis.xlsx`);
  };
</script>
</body>
</html>
